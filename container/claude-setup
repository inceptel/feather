#!/bin/bash
# Claude auth helper - captures OAuth URL for mobile users
# Works for both initial auth and re-auth (expired tokens)
AUTH_URL_FILE="$HOME/claude-auth-url.txt"

# Clean up any old URL file
rm -f "$AUTH_URL_FILE"

echo "Starting Claude authentication..."
echo "The auth URL will be saved for mobile access."
echo "Use the 'Get Auth Link' button on /onboarding/ to get a tappable link."
echo ""

# Run claude auth login, tee output, and capture URL
claude auth login 2>&1 | while IFS= read -r line; do
    echo "$line"
    URL=$(echo "$line" | grep -oP 'https://claude\.ai/oauth/authorize\S+')
    if [ -n "$URL" ]; then
        echo "$URL" > "$AUTH_URL_FILE"
    fi
done

# Check result
sleep 1
STATUS=$(claude auth status 2>&1)
if echo "$STATUS" | grep -q '"loggedIn": true'; then
    echo ""
    echo "Authentication successful!"
    rm -f "$AUTH_URL_FILE"
else
    echo ""
    echo "If you didn't complete auth, the URL is saved."
    echo "Open /onboarding/ and tap 'Get Auth Link'."
fi
