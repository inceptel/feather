<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feather Setup</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0a; color: #e0e0e0; height: 100vh; display: flex; }
        .instructions {
            width: 340px;
            min-width: 340px;
            padding: 28px 24px;
            border-right: 1px solid #2a2a2a;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        .instructions h1 { font-size: 20px; font-weight: 600; color: #daa520; margin-bottom: 4px; }
        .instructions .sub { color: #666; font-size: 13px; margin-bottom: 24px; }
        .step { display: flex; gap: 12px; align-items: flex-start; margin-bottom: 18px; }
        .num { background: #daa520; color: #0a0a0a; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 600; flex-shrink: 0; margin-top: 1px; }
        .step-text h3 { font-size: 14px; color: #f0f0f0; margin-bottom: 2px; }
        .step-text p { font-size: 12px; color: #777; line-height: 1.5; }
        code { background: #1a1a1a; padding: 1px 5px; border-radius: 3px; font-size: 12px; color: #7ec8e3; }
        .terminal-side { flex: 1; display: flex; flex-direction: column; }
        .terminal-side iframe { flex: 1; border: none; background: #000; }
        .status-bar {
            padding: 10px 16px;
            border-top: 1px solid #2a2a2a;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; }
        .dot-ok { background: #4ade80; }
        .dot-err { background: #f87171; }
        .dot-loading { background: #facc15; animation: pulse 1s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }
        .spacer { flex: 1; }
        .back { color: #666; text-decoration: none; font-size: 12px; margin-top: auto; padding-top: 16px; border-top: 1px solid #1a1a1a; }
        .back:hover { color: #aaa; }
        .btn { padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 500; cursor: pointer; border: none; background: #daa520; color: #0a0a0a; display: inline-block; }
        .btn:hover { opacity: 0.9; }
        .btn-outline { background: transparent; border: 1px solid #daa520; color: #daa520; }
        .auth-link-box {
            margin-top: 12px;
            padding: 12px;
            background: #1a1a1a;
            border: 1px solid #2a2a2a;
            border-radius: 8px;
            display: none;
        }
        .auth-link-box a {
            color: #7ec8e3;
            word-break: break-all;
            font-size: 13px;
            line-height: 1.4;
        }
        .auth-link-box .label {
            font-size: 11px;
            color: #666;
            margin-bottom: 6px;
        }
        /* Mobile layout */
        @media (max-width: 768px) {
            body { flex-direction: column; }
            .instructions {
                width: 100%;
                min-width: unset;
                border-right: none;
                border-bottom: 1px solid #2a2a2a;
                max-height: 50vh;
                overflow-y: auto;
            }
            .terminal-side { min-height: 50vh; }
        }
    </style>
</head>
<body>
    <div class="instructions">
        <h1>Feather Setup</h1>
        <p class="sub">Connect your Claude account</p>

        <div class="step">
            <div class="num">1</div>
            <div class="step-text">
                <h3>Run setup in the terminal</h3>
                <p>Type <code>claude-setup</code> and press Enter in the terminal on the right</p>
            </div>
        </div>
        <div class="step">
            <div class="num">2</div>
            <div class="step-text">
                <h3>Open the auth link</h3>
                <p>On desktop, click the link in the terminal. On mobile, tap "Get Auth Link" below.</p>
            </div>
        </div>
        <div class="step">
            <div class="num">3</div>
            <div class="step-text">
                <h3>Complete authorization</h3>
                <p>Sign in to Claude and authorize access, then come back here</p>
            </div>
        </div>

        <div style="margin-top: 20px; display: flex; gap: 8px; flex-wrap: wrap;">
            <button class="btn" onclick="checkAuth()">Check Auth Status</button>
            <button class="btn btn-outline" onclick="getAuthLink()">Get Auth Link</button>
        </div>

        <div id="auth-link-box" class="auth-link-box">
            <div class="label">Tap to open auth page:</div>
            <a id="auth-link" href="#" target="_blank"></a>
        </div>

        <div id="auth-status" style="margin-top: 12px; font-size: 13px;"></div>

        <div class="spacer"></div>
        <a href="/" class="back">Back to Feather</a>
    </div>

    <div class="terminal-side">
        <iframe src="/terminal/"></iframe>
        <div class="status-bar">
            <div id="dot" class="dot dot-loading"></div>
            <span id="status-text">Checking auth...</span>
        </div>
    </div>

    <script>
        function checkAuth() {
            const dot = document.getElementById('dot');
            const text = document.getElementById('status-text');
            const detail = document.getElementById('auth-status');
            dot.className = 'dot dot-loading';
            text.textContent = 'Checking...';

            fetch('/api/claude-auth-status')
                .then(r => r.json())
                .then(d => {
                    if (d.authenticated) {
                        dot.className = 'dot dot-ok';
                        text.textContent = 'Claude is authenticated';
                        detail.innerHTML = '<span style="color:#4ade80;">Ready to go! Close this tab and start using Feather.</span>';
                    } else {
                        dot.className = 'dot dot-err';
                        text.textContent = 'Not authenticated';
                        detail.innerHTML = '<span style="color:#f87171;">' + (d.message || 'Run claude-setup in the terminal to authenticate.') + '</span>';
                    }
                })
                .catch(() => {
                    dot.className = 'dot dot-err';
                    text.textContent = 'Error checking status';
                });
        }

        let pollInterval = null;

        function getAuthLink() {
            const box = document.getElementById('auth-link-box');
            const link = document.getElementById('auth-link');
            box.style.display = 'block';
            link.textContent = 'Looking for auth URL... Run claude-setup in the terminal first.';
            link.href = '#';

            // Poll the Jupyter API for the auth URL file
            let attempts = 0;
            if (pollInterval) clearInterval(pollInterval);

            pollInterval = setInterval(() => {
                attempts++;
                if (attempts > 60) { // Stop after 60 seconds
                    clearInterval(pollInterval);
                    link.textContent = 'Timed out. Run claude-setup again and retry.';
                    return;
                }

                fetch('/jupyter/api/contents/claude-auth-url.txt')
                    .then(r => {
                        if (!r.ok) throw new Error('not found');
                        return r.json();
                    })
                    .then(d => {
                        const url = (d.content || '').trim();
                        if (url && url.startsWith('https://')) {
                            clearInterval(pollInterval);
                            link.href = url;
                            link.textContent = 'Tap here to authenticate with Claude';
                        }
                    })
                    .catch(() => {
                        // File doesn't exist yet, keep polling
                    });
            }, 1000);
        }

        checkAuth();
    </script>
</body>
</html>
