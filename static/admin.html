<!DOCTYPE html>
<html lang="en" class="bg-neutral-950">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Feather Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            smoke: {
              1: '#fcfcfc', 2: '#f8f8f8', 3: '#f0f0f0', 4: '#e8e8e8',
              5: '#ddd', 6: '#d0d0d0', 7: '#b8b8b8', 8: '#a0a0a0',
              9: '#717171', 10: '#5a5a5a', 11: '#3a3a3a', 12: '#1a1a1a',
            }
          }
        }
      }
    }
  </script>
  <style>
    @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: .4; } }
    .pulse-dot { animation: pulse-dot 2s ease-in-out infinite; }
    .spinner { animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-neutral-950 text-smoke-3 min-h-screen p-6 font-mono">
  <div class="max-w-3xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
      <div>
        <h1 class="text-2xl font-bold text-smoke-1">Feather Admin</h1>
        <p class="text-sm text-smoke-8 mt-1">Build management &amp; deployment control</p>
      </div>
      <a href="/" class="text-sm text-smoke-8 hover:text-smoke-4 transition">&larr; Back to app</a>
    </div>

    <!-- Status Card -->
    <div class="bg-neutral-900 border border-neutral-800 rounded-lg p-5 mb-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-smoke-2">Status</h2>
        <button onclick="doRestart()" id="restart-btn"
          class="px-3 py-1.5 text-sm bg-neutral-800 hover:bg-neutral-700 border border-neutral-700 rounded transition">
          Restart Feather
        </button>
      </div>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-sm">
        <div>
          <div class="text-smoke-8 mb-1">Active Version</div>
          <div id="st-version" class="text-smoke-2 font-semibold">...</div>
        </div>
        <div>
          <div class="text-smoke-8 mb-1">Health</div>
          <div id="st-health" class="flex items-center gap-2">
            <span id="health-dot" class="inline-block w-2.5 h-2.5 rounded-full bg-neutral-600"></span>
            <span id="health-text">...</span>
          </div>
        </div>
        <div>
          <div class="text-smoke-8 mb-1">Uptime</div>
          <div id="st-uptime" class="text-smoke-2">...</div>
        </div>
        <div>
          <div class="text-smoke-8 mb-1">Builds</div>
          <div id="st-count" class="text-smoke-2">...</div>
        </div>
      </div>
    </div>

    <!-- Builds List -->
    <div class="bg-neutral-900 border border-neutral-800 rounded-lg p-5">
      <h2 class="text-lg font-semibold text-smoke-2 mb-4">Builds</h2>
      <div id="builds-list" class="space-y-2">
        <div class="text-smoke-8 text-sm">Loading...</div>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 right-6 px-4 py-2 rounded-lg text-sm transition-all duration-300 opacity-0 pointer-events-none"></div>
  </div>

  <script>
    const API = '/admin/api';
    let busy = false;

    function toast(msg, ok = true) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.className = `fixed bottom-6 right-6 px-4 py-2 rounded-lg text-sm transition-all duration-300 ${ok ? 'bg-green-900 text-green-200 border border-green-800' : 'bg-red-900 text-red-200 border border-red-800'}`;
      el.style.opacity = '1';
      setTimeout(() => { el.style.opacity = '0'; }, 3000);
    }

    function fmtSize(bytes) {
      return (bytes / 1024 / 1024).toFixed(1) + ' MB';
    }

    function fmtUptime(secs) {
      if (!secs) return '-';
      const h = Math.floor(secs / 3600);
      const m = Math.floor((secs % 3600) / 60);
      return h > 0 ? `${h}h ${m}m` : `${m}m`;
    }

    function fmtTimestamp(ts) {
      if (!ts) return '';
      return new Date(ts * 1000).toLocaleString();
    }

    async function api(method, path, body) {
      const opts = { method, headers: { 'Content-Type': 'application/json' } };
      if (body) opts.body = JSON.stringify(body);
      const res = await fetch(API + path, opts);
      return res.json();
    }

    async function fetchStatus() {
      try {
        const s = await api('GET', '/status');
        document.getElementById('st-version').textContent = s.active_version || 'unknown';
        const dot = document.getElementById('health-dot');
        const txt = document.getElementById('health-text');
        if (s.healthy) {
          dot.className = 'inline-block w-2.5 h-2.5 rounded-full bg-green-500 pulse-dot';
          txt.textContent = 'UP';
          txt.className = 'text-green-400';
        } else {
          dot.className = 'inline-block w-2.5 h-2.5 rounded-full bg-red-500 pulse-dot';
          txt.textContent = 'DOWN';
          txt.className = 'text-red-400';
        }
        document.getElementById('st-uptime').textContent = fmtUptime(s.uptime_secs);
        document.getElementById('st-count').textContent = s.build_count;
      } catch (e) {
        document.getElementById('health-text').textContent = 'SIDECAR DOWN';
        document.getElementById('health-text').className = 'text-red-400';
      }
    }

    async function fetchBuilds() {
      try {
        const data = await api('GET', '/builds');
        const el = document.getElementById('builds-list');
        if (!data.builds || data.builds.length === 0) {
          el.innerHTML = '<div class="text-smoke-8 text-sm">No builds found. Run deploy.sh to create the first build.</div>';
          return;
        }
        el.innerHTML = data.builds.map(b => `
          <div class="flex items-center justify-between py-2.5 px-3 rounded ${b.active ? 'bg-neutral-800 border border-neutral-700' : 'hover:bg-neutral-800/50'} transition">
            <div class="flex items-center gap-3 min-w-0">
              <span class="font-semibold text-smoke-2 ${b.active ? 'text-green-400' : ''}">${b.version}</span>
              ${b.active ? '<span class="text-xs bg-green-900 text-green-300 px-1.5 py-0.5 rounded">ACTIVE</span>' : ''}
              <span class="text-smoke-8 text-xs">${fmtSize(b.size)}</span>
              <span class="text-smoke-9 text-xs hidden sm:inline">${fmtTimestamp(b.timestamp)}</span>
            </div>
            <div class="flex gap-2">
              ${b.active ? '' : `
                <button onclick="doPromote('${b.version}')"
                  class="px-2.5 py-1 text-xs bg-blue-900 hover:bg-blue-800 text-blue-200 border border-blue-800 rounded transition">
                  Promote
                </button>
                <button onclick="doDelete('${b.version}')"
                  class="px-2.5 py-1 text-xs bg-neutral-800 hover:bg-red-900 text-smoke-8 hover:text-red-200 border border-neutral-700 hover:border-red-800 rounded transition">
                  Delete
                </button>
              `}
            </div>
          </div>
        `).join('');
      } catch (e) {
        document.getElementById('builds-list').innerHTML =
          '<div class="text-red-400 text-sm">Failed to load builds. Is feather-ctl running?</div>';
      }
    }

    async function doPromote(version) {
      if (busy) return;
      if (!confirm(`Promote build ${version}? This will restart Feather.`)) return;
      busy = true;
      toast('Promoting ' + version + '...');
      try {
        const r = await api('POST', '/promote', { version });
        toast(r.ok ? `Promoted ${version}` : (r.message || r.error), r.ok);
      } catch (e) {
        toast('Promote failed: ' + e.message, false);
      }
      busy = false;
      fetchStatus();
      fetchBuilds();
    }

    async function doRestart() {
      if (busy) return;
      if (!confirm('Restart Feather?')) return;
      busy = true;
      const btn = document.getElementById('restart-btn');
      btn.textContent = 'Restarting...';
      btn.disabled = true;
      try {
        const r = await api('POST', '/restart');
        toast(r.healthy ? 'Restarted successfully' : 'Restarted (health check pending)', r.healthy);
      } catch (e) {
        toast('Restart failed: ' + e.message, false);
      }
      btn.textContent = 'Restart Feather';
      btn.disabled = false;
      busy = false;
      fetchStatus();
    }

    async function doDelete(version) {
      if (busy) return;
      if (!confirm(`Delete build ${version}? This cannot be undone.`)) return;
      busy = true;
      try {
        const r = await api('DELETE', '/builds/' + version);
        toast(r.ok ? `Deleted ${version}` : (r.error || 'Delete failed'), r.ok);
      } catch (e) {
        toast('Delete failed: ' + e.message, false);
      }
      busy = false;
      fetchBuilds();
    }

    // Initial load + polling
    fetchStatus();
    fetchBuilds();
    setInterval(fetchStatus, 5000);
    setInterval(fetchBuilds, 30000);
  </script>
</body>
</html>
