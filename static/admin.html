<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feather Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        smoke: {
                            1: '#121212', 2: '#1a1a1a', 3: '#212121', 4: '#252525',
                            5: '#303030', 6: '#3a3a3a', 7: '#4b4c5c', 8: '#5e5e5e',
                            9: '#6a6a6a', 10: '#8a8a8a', 11: '#a0a0a0', 12: '#e0e0e0'
                        },
                        gold: { 9: '#fab283', 10: '#f5a742', 11: '#fcd9b8' },
                        azure: { 9: '#5c9cf5', 10: '#4a8ae6', 11: '#8cbcff' },
                        violet: { 9: '#9d7cd8', 10: '#8b6bc5', 11: '#c4aef0' },
                        apple: { 9: '#7fd88f', 11: '#a8e8b5' },
                        ember: { 9: '#e06c75', 11: '#f0a0a5' },
                        cyan: { 9: '#56b6c2', 11: '#8cd4dd' },
                        amber: { 9: '#e5c07b', 11: '#f0d9a8' }
                    }
                }
            }
        }
    </script>
    <style>
        html, body { height: 100%; }
        ::selection { background: rgba(250, 178, 131, 0.3); }
        @keyframes spin { to { transform: rotate(360deg); } }
        .thin-scrollbar::-webkit-scrollbar { width: 6px; }
        .thin-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .thin-scrollbar::-webkit-scrollbar-thumb { background: #3a3a3a; border-radius: 3px; }
        .tab-active { border-color: #fab283; color: #fab283; }
        .log-area { font-family: ui-monospace, 'SF Mono', 'Cascadia Code', monospace; }
    </style>
</head>
<body class="bg-smoke-1 text-smoke-12 min-h-screen">
    <div class="max-w-4xl mx-auto p-6">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
                <a href="/" class="text-smoke-8 hover:text-smoke-12 transition-colors" title="Back to Feather">&larr;</a>
                <span class="text-xl">ðŸª¶</span>
                <div>
                    <h1 class="text-xl font-bold text-gold-9">Admin Panel</h1>
                    <p class="text-xs text-smoke-8" id="admin-subtitle">Loading...</p>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <span id="sse-indicator" class="w-2 h-2 rounded-full bg-smoke-5" title="SSE disconnected"></span>
                <button onclick="refreshStatus()" class="px-3 py-1.5 bg-smoke-3 hover:bg-smoke-4 border border-smoke-5 rounded text-xs text-smoke-10 hover:text-smoke-12 transition-all">Refresh</button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="flex border-b border-smoke-5 mb-6">
            <button onclick="switchTab('supervisor')" id="tab-supervisor" class="px-5 py-3 text-sm font-medium text-smoke-10 hover:text-smoke-12 border-b-2 border-transparent transition-all">Supervisor</button>
            <button onclick="switchTab('app')" id="tab-app" class="px-5 py-3 text-sm font-medium text-smoke-10 hover:text-smoke-12 border-b-2 border-transparent transition-all">App</button>
            <button onclick="switchTab('container')" id="tab-container" class="px-5 py-3 text-sm font-medium text-smoke-10 hover:text-smoke-12 border-b-2 border-transparent transition-all hidden">Container</button>
        </div>

        <!-- ================================================================ -->
        <!-- Supervisor Panel -->
        <!-- ================================================================ -->
        <div id="panel-supervisor" class="space-y-6 hidden">
            <div class="bg-smoke-2 border border-smoke-5 rounded-lg p-5">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-sm font-semibold text-smoke-11 uppercase tracking-wider">Running Services</h2>
                    <button onclick="rollbackSupervisor()" id="svc-rollback-btn" class="px-3 py-1.5 bg-smoke-3 hover:bg-smoke-4 border border-smoke-5 rounded text-xs text-smoke-10 hover:text-amber-9 transition-all hidden">Rollback Config</button>
                </div>
                <div id="services-list" class="space-y-2">
                    <p class="text-smoke-8 text-sm">Loading...</p>
                </div>
            </div>

            <div class="bg-smoke-2 border border-smoke-5 rounded-lg p-5">
                <h2 class="text-sm font-semibold text-smoke-11 uppercase tracking-wider mb-4">Add Service</h2>
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs text-smoke-9 mb-1">Name</label>
                            <input id="svc-name" type="text" placeholder="my-service" class="w-full px-3 py-2 bg-smoke-3 border border-smoke-5 rounded-lg text-sm text-smoke-12 placeholder-smoke-7 focus:outline-none focus:border-gold-9">
                        </div>
                        <div>
                            <label class="block text-xs text-smoke-9 mb-1">Port (optional)</label>
                            <input id="svc-port" type="number" placeholder="9999" class="w-full px-3 py-2 bg-smoke-3 border border-smoke-5 rounded-lg text-sm text-smoke-12 placeholder-smoke-7 focus:outline-none focus:border-gold-9">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs text-smoke-9 mb-1">Command</label>
                        <input id="svc-command" type="text" placeholder="python3 -m http.server 9999" class="w-full px-3 py-2 bg-smoke-3 border border-smoke-5 rounded-lg text-sm text-smoke-12 placeholder-smoke-7 focus:outline-none focus:border-gold-9">
                    </div>
                    <div>
                        <label class="block text-xs text-smoke-9 mb-1">Caddy route (optional)</label>
                        <input id="svc-caddy" type="text" placeholder="/myapp" class="w-full px-3 py-2 bg-smoke-3 border border-smoke-5 rounded-lg text-sm text-smoke-12 placeholder-smoke-7 focus:outline-none focus:border-gold-9">
                    </div>
                    <button onclick="addService()" class="px-4 py-2 bg-gold-10 hover:bg-gold-9 text-smoke-1 rounded-lg text-sm font-medium transition-colors">Add Service</button>
                </div>
            </div>

            <div id="svc-log-section" class="hidden">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-xs text-smoke-9 uppercase tracking-wider">Log</h3>
                    <button onclick="clearLog('svc')" class="text-xs text-smoke-8 hover:text-smoke-12">Clear</button>
                </div>
                <div id="svc-log" class="log-area bg-smoke-2 border border-smoke-5 rounded-lg p-4 text-xs text-smoke-10 max-h-60 overflow-y-auto thin-scrollbar"></div>
            </div>
        </div>

        <!-- ================================================================ -->
        <!-- App Panel -->
        <!-- ================================================================ -->
        <div id="panel-app" class="space-y-6 hidden">
            <div class="bg-smoke-2 border border-smoke-5 rounded-lg p-5">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-sm font-semibold text-smoke-11 uppercase tracking-wider">Feather Binary</h2>
                        <p class="text-sm text-smoke-9 mt-1">Current version: <span id="app-version" class="font-mono text-gold-9">â€”</span></p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="rollbackApp()" id="app-rollback-btn" class="px-4 py-2 bg-smoke-3 hover:bg-smoke-4 border border-smoke-5 rounded-lg text-sm text-smoke-10 hover:text-amber-9 transition-all hidden">Rollback</button>
                        <button onclick="deployApp()" id="app-deploy-btn" class="px-4 py-2 bg-gold-10 hover:bg-gold-9 text-smoke-1 rounded-lg text-sm font-medium transition-colors">Build & Deploy</button>
                    </div>
                </div>
            </div>

            <div id="app-progress-section" class="hidden">
                <div class="bg-smoke-2 border border-gold-9/30 rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-4 h-4 border-2 border-gold-9 border-t-transparent rounded-full" style="animation: spin 1s linear infinite"></div>
                        <span id="app-stage" class="text-sm text-gold-9">Building...</span>
                    </div>
                    <div class="w-full bg-smoke-4 rounded-full h-1.5">
                        <div id="app-bar" class="bg-gold-9 h-1.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div id="app-log-section" class="hidden">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-xs text-smoke-9 uppercase tracking-wider">Build Output</h3>
                    <button onclick="clearLog('app')" class="text-xs text-smoke-8 hover:text-smoke-12">Clear</button>
                </div>
                <div id="app-log" class="log-area bg-smoke-2 border border-smoke-5 rounded-lg p-4 text-xs text-smoke-10 max-h-96 overflow-y-auto thin-scrollbar"></div>
            </div>
        </div>

        <!-- ================================================================ -->
        <!-- Container Panel (admin only) -->
        <!-- ================================================================ -->
        <div id="panel-container" class="space-y-6 hidden">
            <div class="bg-smoke-2 border border-smoke-5 rounded-lg p-5">
                <h2 class="text-sm font-semibold text-smoke-11 uppercase tracking-wider mb-4">Container Deploy</h2>
                <p class="text-sm text-smoke-9 mb-4">Rebuild container image and redeploy via host. This runs <code class="bg-smoke-4 px-1.5 py-0.5 rounded text-cyan-9 text-xs">deploy.sh</code> on the host machine.</p>
                <div class="flex items-center gap-3">
                    <div>
                        <label class="block text-xs text-smoke-9 mb-1">Target</label>
                        <select id="container-target" class="px-3 py-2 bg-smoke-3 border border-smoke-5 rounded-lg text-sm text-smoke-11 focus:outline-none focus:border-gold-9 min-w-[120px]">
                            <option value="user0">user0</option>
                            <option value="user1">user1</option>
                            <option value="all">all</option>
                        </select>
                    </div>
                    <div class="flex gap-2 self-end">
                        <button onclick="deployContainer()" id="container-deploy-btn" class="px-4 py-2 bg-gold-10 hover:bg-gold-9 text-smoke-1 rounded-lg text-sm font-medium transition-colors">Deploy</button>
                        <button onclick="rollbackContainer()" class="px-4 py-2 bg-smoke-3 hover:bg-smoke-4 border border-smoke-5 rounded-lg text-sm text-smoke-10 hover:text-amber-9 transition-all">Rollback</button>
                    </div>
                </div>
            </div>

            <div id="container-progress-section" class="hidden">
                <div class="bg-smoke-2 border border-gold-9/30 rounded-lg p-4">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-4 h-4 border-2 border-gold-9 border-t-transparent rounded-full" style="animation: spin 1s linear infinite"></div>
                        <span id="container-stage" class="text-sm text-gold-9">Deploying...</span>
                    </div>
                    <div class="w-full bg-smoke-4 rounded-full h-1.5">
                        <div id="container-bar" class="bg-gold-9 h-1.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div id="container-log-section" class="hidden">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-xs text-smoke-9 uppercase tracking-wider">Host Output</h3>
                    <button onclick="clearLog('container')" class="text-xs text-smoke-8 hover:text-smoke-12">Clear</button>
                </div>
                <div id="container-log" class="log-area bg-smoke-2 border border-smoke-5 rounded-lg p-4 text-xs text-smoke-10 max-h-96 overflow-y-auto thin-scrollbar"></div>
            </div>
        </div>
    </div>

    <script>
        // ========== State ==========
        let activeTab = 'app';
        let deploySSE = null;
        let statusData = null;

        // ========== Init ==========
        document.addEventListener('DOMContentLoaded', () => {
            refreshStatus();
            connectSSE();
            switchTab('app');
        });

        // ========== Tabs ==========
        function switchTab(tab) {
            activeTab = tab;
            ['supervisor', 'app', 'container'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                const panel = document.getElementById(`panel-${t}`);
                if (t === tab) {
                    btn.classList.add('tab-active');
                    btn.classList.remove('text-smoke-10');
                    panel.classList.remove('hidden');
                } else {
                    btn.classList.remove('tab-active');
                    btn.classList.add('text-smoke-10');
                    panel.classList.add('hidden');
                }
            });
        }

        // ========== Status ==========
        async function refreshStatus() {
            try {
                const resp = await fetch('/api/deploy/status');
                statusData = await resp.json();

                // Subtitle
                document.getElementById('admin-subtitle').textContent =
                    `v${statusData.version} ${statusData.is_admin ? '(admin)' : ''}`;

                // Container tab visibility
                const containerTab = document.getElementById('tab-container');
                if (statusData.is_admin) {
                    containerTab.classList.remove('hidden');
                } else {
                    containerTab.classList.add('hidden');
                }

                // App version
                document.getElementById('app-version').textContent = statusData.version || 'â€”';

                // App rollback
                const appRollback = document.getElementById('app-rollback-btn');
                statusData.has_app_backup ? appRollback.classList.remove('hidden') : appRollback.classList.add('hidden');

                // Supervisor rollback
                const svcRollback = document.getElementById('svc-rollback-btn');
                statusData.has_supervisor_backup ? svcRollback.classList.remove('hidden') : svcRollback.classList.add('hidden');

                // Services list
                renderServices(statusData.services);
            } catch (e) {
                document.getElementById('admin-subtitle').textContent = 'Failed to load status';
                console.error('Status error:', e);
            }
        }

        function renderServices(services) {
            const list = document.getElementById('services-list');
            if (!services || services.length === 0) {
                list.innerHTML = '<p class="text-smoke-8 text-sm">No managed services</p>';
                return;
            }
            list.innerHTML = services.map(svc => {
                const running = svc.status === 'RUNNING';
                const dotColor = running ? 'bg-apple-9' : 'bg-ember-9';
                const statusColor = running ? 'text-apple-9' : svc.status === 'STOPPED' ? 'text-ember-9' : 'text-amber-9';
                const detail = svc.uptime ? `uptime ${svc.uptime}` : svc.pid ? `pid ${svc.pid}` : '';
                return `<div class="flex items-center justify-between py-2.5 px-3 bg-smoke-3 rounded-lg">
                    <div class="flex items-center gap-3">
                        <span class="w-2 h-2 rounded-full ${dotColor} flex-shrink-0"></span>
                        <span class="text-smoke-12 font-medium text-sm">${esc(svc.name)}</span>
                        <span class="${statusColor} text-xs">${esc(svc.status)}</span>
                        ${detail ? `<span class="text-smoke-8 text-xs">${esc(detail)}</span>` : ''}
                    </div>
                    <button onclick="removeService('${esc(svc.name)}')" class="text-xs text-smoke-8 hover:text-ember-9 px-2 py-1 rounded hover:bg-ember-9/10 transition-all">Remove</button>
                </div>`;
            }).join('');
        }

        function esc(s) {
            const d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }

        // ========== SSE ==========
        function connectSSE() {
            if (deploySSE) deploySSE.close();
            deploySSE = new EventSource('/api/deploy/stream');

            const indicator = document.getElementById('sse-indicator');

            deploySSE.onopen = () => {
                indicator.classList.remove('bg-smoke-5', 'bg-ember-9');
                indicator.classList.add('bg-apple-9');
                indicator.title = 'SSE connected';
            };

            ['supervisor', 'app', 'container'].forEach(track => {
                deploySSE.addEventListener(`deploy-${track}`, (e) => {
                    try {
                        handleEvent(track, JSON.parse(e.data));
                    } catch (err) {
                        console.error('SSE parse error:', err);
                    }
                });
            });

            deploySSE.onerror = () => {
                indicator.classList.remove('bg-apple-9');
                indicator.classList.add('bg-ember-9');
                indicator.title = 'SSE disconnected, reconnecting...';
                // Auto-reconnect (handles feather restarting after Track 2 deploy)
                setTimeout(() => {
                    appendLog('app', '--- Reconnecting... ---');
                    connectSSE();
                    setTimeout(refreshStatus, 2000);
                }, 3000);
            };
        }

        function handleEvent(track, data) {
            if (data.type === 'output') {
                appendLog(track, data.line);
            } else if (data.type === 'progress') {
                showProgress(track, data.stage, data.pct);
            } else if (data.type === 'complete') {
                hideProgress(track);
                const prefix = data.success ? 'DONE' : 'FAILED';
                appendLog(track, `--- ${prefix}: ${data.message} ---`);
                resetButton(track);
                setTimeout(refreshStatus, 1500);
            }
        }

        // ========== Logging ==========
        function appendLog(track, line) {
            const logId = track === 'supervisor' ? 'svc' : track;
            const section = document.getElementById(`${logId}-log-section`);
            const log = document.getElementById(`${logId}-log`);
            if (!log) return;
            section.classList.remove('hidden');
            const div = document.createElement('div');
            div.textContent = line;
            div.className = 'py-0.5';
            if (line.includes('FAILED') || line.includes('Error') || line.includes('error[')) {
                div.classList.add('text-ember-9');
            } else if (line.includes('DONE') || line.includes('complete') || line.includes('Compiling')) {
                div.classList.add('text-apple-9');
            } else if (line.includes('warning')) {
                div.classList.add('text-amber-9');
            }
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        function clearLog(logId) {
            const log = document.getElementById(`${logId}-log`);
            if (log) log.innerHTML = '';
            const section = document.getElementById(`${logId}-log-section`);
            if (section) section.classList.add('hidden');
        }

        // ========== Progress ==========
        function showProgress(track, stage, pct) {
            const sectionId = track === 'supervisor' ? null : `${track}-progress-section`;
            if (!sectionId) return;
            const section = document.getElementById(sectionId);
            if (section) section.classList.remove('hidden');
            const stageEl = document.getElementById(`${track}-stage`);
            const barEl = document.getElementById(`${track}-bar`);
            if (stageEl) stageEl.textContent = stage || 'Working...';
            if (barEl && pct != null) barEl.style.width = pct + '%';
        }

        function hideProgress(track) {
            const sectionId = track === 'supervisor' ? null : `${track}-progress-section`;
            if (!sectionId) return;
            const section = document.getElementById(sectionId);
            if (section) section.classList.add('hidden');
        }

        function resetButton(track) {
            if (track === 'app') {
                const btn = document.getElementById('app-deploy-btn');
                btn.disabled = false;
                btn.textContent = 'Build & Deploy';
                btn.classList.remove('opacity-50', 'cursor-wait');
            } else if (track === 'container') {
                const btn = document.getElementById('container-deploy-btn');
                btn.disabled = false;
                btn.textContent = 'Deploy';
                btn.classList.remove('opacity-50', 'cursor-wait');
            }
        }

        // ========== Track 1: Supervisor ==========
        async function addService() {
            const name = document.getElementById('svc-name').value.trim();
            const command = document.getElementById('svc-command').value.trim();
            const port = document.getElementById('svc-port').value.trim();
            const caddy = document.getElementById('svc-caddy').value.trim();

            if (!name || !command) {
                alert('Name and command are required');
                return;
            }

            const body = { action: 'add', name, command };
            if (port) body.port = parseInt(port);
            if (caddy) body.caddy_route = caddy;

            try {
                const resp = await fetch('/api/deploy/supervisor', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await resp.json();
                if (data.status === 'ok') {
                    document.getElementById('svc-name').value = '';
                    document.getElementById('svc-command').value = '';
                    document.getElementById('svc-port').value = '';
                    document.getElementById('svc-caddy').value = '';
                    setTimeout(refreshStatus, 1000);
                } else {
                    alert(data.message || 'Failed to add service');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function removeService(name) {
            if (!confirm(`Remove service "${name}"?\nThis will stop the process and remove it from supervisor.`)) return;
            try {
                const resp = await fetch('/api/deploy/supervisor', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'remove', name })
                });
                const data = await resp.json();
                if (data.status !== 'ok') alert(data.message || 'Failed');
                setTimeout(refreshStatus, 1000);
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function rollbackSupervisor() {
            if (!confirm('Rollback supervisor config to previous state?\nThis restores the .prev backup of supervisord.conf and Caddyfile.')) return;
            try {
                await fetch('/api/deploy/supervisor/rollback', { method: 'POST' });
                setTimeout(refreshStatus, 2000);
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // ========== Track 2: App ==========
        async function deployApp() {
            if (!confirm('Rebuild and deploy feather from source?\nThis will compile the binary, replace the running version, and restart.')) return;

            const btn = document.getElementById('app-deploy-btn');
            btn.disabled = true;
            btn.textContent = 'Building...';
            btn.classList.add('opacity-50', 'cursor-wait');
            clearLog('app');

            try {
                await fetch('/api/deploy/app', { method: 'POST' });
            } catch (e) {
                resetButton('app');
                alert('Error: ' + e.message);
            }
        }

        async function rollbackApp() {
            if (!confirm('Rollback to previous feather binary?\nThis restores the .prev backup and restarts.')) return;
            clearLog('app');
            try {
                await fetch('/api/deploy/app/rollback', { method: 'POST' });
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // ========== Track 3: Container ==========
        async function deployContainer() {
            const target = document.getElementById('container-target').value;
            if (!confirm(`Deploy container for "${target}"?\nThis runs deploy.sh on the host (podman build + redeploy). Takes 2-5 minutes.`)) return;

            const btn = document.getElementById('container-deploy-btn');
            btn.disabled = true;
            btn.textContent = 'Deploying...';
            btn.classList.add('opacity-50', 'cursor-wait');
            clearLog('container');

            try {
                await fetch('/api/deploy/container', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target })
                });
            } catch (e) {
                resetButton('container');
                alert('Error: ' + e.message);
            }
        }

        async function rollbackContainer() {
            const target = document.getElementById('container-target').value;
            if (!confirm(`Rollback container for "${target}"?\nThis runs rollback.sh on the host.`)) return;
            clearLog('container');
            try {
                await fetch('/api/deploy/container/rollback', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target })
                });
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }
    </script>
</body>
</html>
