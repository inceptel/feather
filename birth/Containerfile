FROM docker.io/library/ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

# Just need caddy, curl, jq â€” podman runs on host via socket
RUN apt-get update && apt-get install -y \
       curl jq ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Caddy binary
RUN curl -fsSL "https://caddyserver.com/api/download?os=linux&arch=amd64" -o /usr/local/bin/caddy \
    && chmod +x /usr/local/bin/caddy

# Install podman-remote for talking to host podman via socket
RUN curl -fsSL "https://github.com/containers/podman/releases/download/v5.3.1/podman-remote-static-linux_amd64.tar.gz" \
    | tar xz -C /usr/local/bin --strip-components=1 \
    && mv /usr/local/bin/podman-remote-static-linux_amd64 /usr/local/bin/podman

# Caddy config and scripts
COPY caddy.json /opt/birth/caddy.json
COPY entrypoint.sh /entrypoint.sh
COPY swap.sh /usr/local/bin/swap.sh

RUN chmod +x /entrypoint.sh /usr/local/bin/swap.sh

ENTRYPOINT ["/entrypoint.sh"]
